<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRBL Web Control Pro v3.0</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        purple: {
                            dark: '#2D1B69',
                            medium: '#5B4B9F',
                            light: '#7B6BB8',
                            pale: '#B5A8D6',
                            'ultra-pale': '#E8E4F3',
                            bg: '#F5F3FA'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Fabric.js for canvas manipulation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

    <!-- Makerjs for G-code generation -->
    <script src="https://cdn.jsdelivr.net/npm/makerjs@0.17.0/dist/index.js"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-purple-bg">
    <div x-data="grblApp()" class="flex h-screen overflow-hidden">

        <!-- Left Sidebar -->
        <aside class="w-72 bg-white border-r border-gray-200 flex flex-col">
            <!-- Logo & GitHub -->
            <div class="bg-purple-dark text-white p-5">
                <div class="flex items-center justify-between mb-2">
                    <h1 class="text-xl font-bold">GRBL Control Pro</h1>
                    <span class="text-xs bg-purple-medium px-2 py-1 rounded">v3.0</span>
                </div>
                <a href="https://github.com/makerspace-lab/grbl-web-control-pro"
                   target="_blank"
                   class="flex items-center gap-2 text-xs text-purple-pale hover:text-white transition">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                    </svg>
                    <span>GitHub</span>
                </a>
            </div>

            <!-- Connection Status -->
            <div class="p-5 border-b border-gray-200">
                <div class="flex items-center gap-3 mb-4">
                    <div class="flex items-center gap-2">
                        <div :class="connected ? 'bg-green-500 animate-pulse' : 'bg-gray-400'"
                             class="w-3 h-3 rounded-full"></div>
                        <span class="text-sm font-medium" x-text="connected ? 'Conectado' : 'Desconectado'"></span>
                    </div>
                </div>
                <button @click="toggleConnection"
                        :class="connected ? 'bg-red-500 hover:bg-red-600' : 'bg-purple-medium hover:bg-purple-dark'"
                        class="w-full text-white px-4 py-2 rounded-lg font-medium transition">
                    <span x-text="connected ? 'Desconectar' : 'Conectar'"></span>
                </button>
                <select class="w-full mt-2 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    <option value="115200">115200</option>
                    <option value="9600">9600</option>
                </select>
            </div>

            <!-- Machine State -->
            <div x-show="connected" class="p-5 border-b border-gray-200">
                <h3 class="text-xs font-semibold text-purple-dark mb-3 uppercase tracking-wider">Estado M√°quina</h3>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Estado:</span>
                        <span class="px-2 py-1 bg-purple-ultra-pale text-purple-dark rounded text-xs font-medium"
                              x-text="machineState"></span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Feed:</span>
                        <span x-text="feedOverride + '%'"></span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Spindle:</span>
                        <span x-text="spindleOverride + '%'"></span>
                    </div>
                </div>
            </div>

            <!-- Position Display -->
            <div x-show="connected" class="p-5 border-b border-gray-200">
                <h3 class="text-xs font-semibold text-purple-dark mb-3 uppercase tracking-wider">Posici√≥n</h3>
                <div class="space-y-2">
                    <template x-for="axis in ['X', 'Y', 'Z']" :key="axis">
                        <div class="flex justify-between items-center bg-purple-ultra-pale rounded-lg p-2">
                            <span class="font-medium text-sm" x-text="axis + ':'"></span>
                            <span class="font-mono text-purple-medium font-semibold" x-text="position[axis.toLowerCase()]"></span>
                        </div>
                    </template>
                </div>
                <button @click="togglePosMode" class="w-full mt-3 text-xs bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded transition">
                    <span x-text="posMode"></span>
                </button>
            </div>

            <!-- Quick Controls -->
            <div x-show="connected" class="p-5 border-b border-gray-200">
                <h3 class="text-xs font-semibold text-purple-dark mb-3 uppercase tracking-wider">Control R√°pido</h3>
                <div class="grid grid-cols-4 gap-2">
                    <button @click="sendCommand('$H')"
                            class="aspect-square bg-purple-ultra-pale hover:bg-purple-pale rounded-lg transition flex items-center justify-center text-2xl"
                            title="Home">üè†</button>
                    <button @click="sendCommand('$X')"
                            class="aspect-square bg-purple-ultra-pale hover:bg-purple-pale rounded-lg transition flex items-center justify-center text-2xl"
                            title="Unlock">üîì</button>
                    <button @click="reset"
                            class="aspect-square bg-red-100 hover:bg-red-200 rounded-lg transition flex items-center justify-center text-2xl"
                            title="Reset">‚ö†Ô∏è</button>
                    <button @click="emergencyStop"
                            class="aspect-square bg-red-500 hover:bg-red-600 text-white rounded-lg transition flex items-center justify-center text-2xl"
                            title="Stop">‚èπÔ∏è</button>
                </div>
            </div>

            <!-- Workspace Offset -->
            <div x-show="connected" class="p-5 flex-1 overflow-auto">
                <h3 class="text-xs font-semibold text-purple-dark mb-3 uppercase tracking-wider">Offset Trabajo</h3>
                <select class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-2"
                        @change="sendCommand($event.target.value)">
                    <option value="G54">G54 (WCS 1)</option>
                    <option value="G55">G55 (WCS 2)</option>
                    <option value="G56">G56 (WCS 3)</option>
                    <option value="G57">G57 (WCS 4)</option>
                    <option value="G58">G58 (WCS 5)</option>
                    <option value="G59">G59 (WCS 6)</option>
                </select>
                <div class="space-y-2">
                    <button @click="sendCommand('G92 X0 Y0 Z0')"
                            class="w-full text-xs bg-purple-medium hover:bg-purple-dark text-white px-3 py-2 rounded-lg transition">
                        Set Zero (G92)
                    </button>
                    <button @click="sendCommand('G92.1')"
                            class="w-full text-xs bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-lg transition">
                        Clear (G92.1)
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">

            <!-- Top Toolbar -->
            <div class="bg-white border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button @click="loadSVG"
                                class="flex items-center gap-2 bg-purple-medium hover:bg-purple-dark text-white px-4 py-2 rounded-lg transition">
                            <span>üìÅ</span>
                            <span>Cargar SVG</span>
                        </button>
                        <input type="file" accept=".svg" class="hidden" x-ref="svgInput" @change="handleSVGUpload">

                        <button @click="generateGCode"
                                :disabled="!svgLoaded"
                                :class="svgLoaded ? 'bg-blue-500 hover:bg-blue-600' : 'bg-gray-300 cursor-not-allowed'"
                                class="flex items-center gap-2 text-white px-4 py-2 rounded-lg transition">
                            <span>‚öôÔ∏è</span>
                            <span>Generar G-code</span>
                        </button>

                        <button @click="downloadGCode"
                                :disabled="!gcodeGenerated"
                                :class="gcodeGenerated ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-300 cursor-not-allowed'"
                                class="flex items-center gap-2 text-white px-4 py-2 rounded-lg transition">
                            <span>üíæ</span>
                            <span>Descargar</span>
                        </button>

                        <button @click="sendToGRBL"
                                :disabled="!connected || !gcodeGenerated"
                                :class="connected && gcodeGenerated ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-300 cursor-not-allowed'"
                                class="flex items-center gap-2 text-white px-4 py-2 rounded-lg transition">
                            <span>‚ñ∂Ô∏è</span>
                            <span>Enviar</span>
                        </button>
                    </div>

                    <div class="flex items-center gap-3">
                        <button @click="openModal('grblSettings')"
                                class="flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-gray-100 transition">
                            <span>‚öôÔ∏è</span>
                            <span>Config GRBL</span>
                        </button>
                        <button @click="openModal('toolsLibrary')"
                                class="flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-gray-100 transition">
                            <span>üîß</span>
                            <span>Herramientas</span>
                        </button>
                        <button @click="openModal('materialsLibrary')"
                                class="flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-gray-100 transition">
                            <span>üì¶</span>
                            <span>Materiales</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Workspace Container -->
            <div class="flex-1 flex overflow-hidden">

                <!-- Canvas Panel -->
                <div class="flex-1 flex flex-col bg-purple-bg">

                    <!-- Canvas Toolbar -->
                    <div class="bg-white border-b border-gray-200 px-6 py-3 flex items-center justify-between">
                        <div class="flex items-center gap-2">
<div class="flex items-center gap-3">
    <div class="flex items-center gap-1">
        <span class="text-xs text-gray-600">Ancho:</span>
        <input type="number"
               x-model.number="svgWidth"
               @input="updateSVGWidth()"
               step="1"
               min="1"
               class="w-16 px-2 py-1 border border-gray-300 rounded text-xs text-right">
        <span class="text-xs text-gray-500">mm</span>
    </div>

    <button @click="proportionalScale = !proportionalScale"
            :class="proportionalScale ? 'bg-purple-medium text-white' : 'bg-gray-200'"
            class="px-2 py-1 rounded transition"
            title="Escala proporcional">
        <span x-show="proportionalScale">üîí</span>
        <span x-show="!proportionalScale">üîì</span>
    </button>

    <div class="flex items-center gap-1">
        <span class="text-xs text-gray-600">Alto:</span>
        <input type="number"
               x-model.number="svgHeight"
               @input="updateSVGHeight()"
               step="1"
               min="1"
               class="w-16 px-2 py-1 border border-gray-300 rounded text-xs text-right">
        <span class="text-xs text-gray-500">mm</span>
    </div>
</div>
                        </div>

                        <div class="flex items-center gap-4 text-sm text-gray-600">
                            <span>√Årea: <span x-text="workAreaSize"></span> mm</span>
                            <button @click="openModal('workArea')" class="hover:text-purple-medium">‚úèÔ∏è</button>
                        </div>

                        <div class="flex items-center gap-2">
                            <button @click="zoomIn" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition text-sm">
                                üîç+
                            </button>
                            <button @click="zoomOut" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition text-sm">
                                üîç-
                            </button>
                            <button @click="fitView" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition text-sm">
                                ‚ä°
                            </button>
                            <button @click="resetOrigin" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition text-sm">
                                üìç Origen
                            </button>
                        </div>
                    </div>

                    <!-- Canvas - SIN BG-WHITE QUE TAPA FABRIC.JS -->
                    <div class="flex-1 p-4 relative">
                        <canvas x-ref="canvas" class="w-full h-full rounded-lg shadow-lg"></canvas>
                    </div>

                    <!-- Canvas Footer -->
                    <div class="bg-white border-t border-gray-200 px-6 py-3 flex items-center justify-between text-sm text-gray-600">
                        <div class="flex items-center gap-6">
                            <span>Posici√≥n: <span x-text="svgPosition"></span></span>
                            <span>Escala: <span x-text="svgScale"></span></span>
                            <span>Rotaci√≥n: <span x-text="svgRotation"></span></span>
                        </div>
                    </div>
                </div>

                <!-- Right Panel -->
                <div class="w-96 bg-white border-l border-gray-200 flex flex-col">

                    <!-- Tabs -->
                    <div class="flex border-b border-gray-200 bg-gray-50">
                        <template x-for="tab in tabs" :key="tab.id">
                            <button @click="currentTab = tab.id"
                                    :class="currentTab === tab.id ? 'border-b-2 border-purple-medium bg-white font-semibold' : 'text-gray-600'"
                                    class="flex-1 px-4 py-3 text-sm transition"
                                    x-text="tab.icon + ' ' + tab.name">
                            </button>
                        </template>
                    </div>

                    <!-- Tab Content -->
                    <div class="flex-1 overflow-y-auto p-6">

<!-- Elements Tab -->
<div x-show="currentTab === 'elements'" class="space-y-4">
    <!-- Global Config -->
    <div class="bg-purple-ultra-pale rounded-lg p-4">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-purple-dark">‚öôÔ∏è Config Global</h3>
            <span class="text-xs px-2 py-1 rounded"
                  :class="configStatus === 'unified' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'"
                  x-text="configStatus === 'unified' ? '‚úÖ Unificada' : '‚ö†Ô∏è M√∫ltiple'"></span>
        </div>

        <div class="space-y-2 text-sm">
            <select x-model="globalConfig.operationType" class="w-full px-2 py-1 border rounded text-xs">
                <option value="cnc">CNC Corte</option>
                <option value="laser-engrave">L√°ser Grabado</option>
                <option value="laser-cut">L√°ser Corte</option>
            </select>

            <div x-show="globalConfig.operationType === 'cnc'">
                <select x-model="globalConfig.tool" class="w-full px-2 py-1 border rounded text-xs">
                    <option value="">Sin herramienta</option>
                    <template x-for="tool in tools" :key="tool.name">
                        <option :value="tool.name" x-text="tool.name"></option>
                    </template>
                </select>
            </div>

            <div x-show="globalConfig.operationType.startsWith('laser')" class="flex gap-2">
                <input type="number" x-model="globalConfig.laserPower" min="0" max="100"
                       class="flex-1 px-2 py-1 border rounded text-xs" placeholder="Potencia %">
                <input type="number" x-model="globalConfig.passes" min="1" max="10"
                       class="w-16 px-2 py-1 border rounded text-xs" placeholder="Pasadas">
            </div>

            <button @click="applyGlobalConfigToAll"
                    class="w-full bg-purple-medium hover:bg-purple-dark text-white px-3 py-2 rounded text-xs transition">
                ‚úÖ Aplicar a todos
            </button>
        </div>
    </div>

    <!-- Elements List -->
    <div>
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-semibold text-purple-dark">üìã Elementos (<span x-text="elements.length"></span>)</h3>
            <div class="relative" x-data="{open: false}">
                <button @click="open = !open"
                        class="text-xs bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded transition">
                    ‚ûï Agregar
                </button>
                <div x-show="open" @click.away="open = false"
                     class="absolute right-0 mt-1 bg-white border rounded-lg shadow-lg z-10 w-40">
                    <button @click="loadSVG(); open = false"
                            class="w-full text-left px-3 py-2 hover:bg-gray-100 text-xs">üìÅ Cargar SVG</button>
                    <button @click="addDrawingElement('rect'); open = false"
                            class="w-full text-left px-3 py-2 hover:bg-gray-100 text-xs">üü¶ Rect√°ngulo</button>
                    <button @click="addDrawingElement('circle'); open = false"
                            class="w-full text-left px-3 py-2 hover:bg-gray-100 text-xs">‚≠ï C√≠rculo</button>
                    <button @click="addDrawingElement('line'); open = false"
                            class="w-full text-left px-3 py-2 hover:bg-gray-100 text-xs">‚ûñ L√≠nea</button>
                </div>
            </div>
        </div>

        <div class="space-y-2 max-h-96 overflow-y-auto">
            <template x-for="element in elements" :key="element.id">
                <div class="border rounded-lg p-2 bg-white">
                    <!-- Element Header -->
                    <div class="flex items-center gap-2">
                        <button @click="toggleElementVisibility(element.id)"
                                class="text-lg" x-text="element.visible ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'"></button>
                        <button @click="toggleElementLock(element.id)"
                                class="text-lg" x-text="element.locked ? 'üîí' : 'üîì'"></button>
                        <span class="text-lg" x-text="element.type === 'svg' ? 'üìÅ' : element.type === 'rect' ? 'üü¶' : element.type === 'circle' ? '‚≠ï' : '‚ûñ'"></span>
                        <span class="flex-1 text-sm font-medium" x-text="element.name"></span>
                        <button @click="toggleExpandElement(element.id)"
                                x-show="element.type === 'svg'"
                                class="text-xs px-2 py-1 bg-gray-100 rounded"
                                x-text="element.expanded ? 'üîº' : 'üîΩ'"></button>
                        <button @click="deleteElement(element.id)"
                                class="text-red-500 hover:text-red-700 text-xs">üóëÔ∏è</button>
                    </div>

                    <!-- Element Config Status -->
                    <div class="mt-2 text-xs">
                        <span class="text-gray-600">‚öôÔ∏è </span>
                        <span x-show="!element.config" class="text-gray-500">[hereda global]</span>
                        <span x-show="element.config" class="text-purple-medium font-medium">
                            ‚úèÔ∏è <span x-text="element.config?.operationType"></span>
                        </span>
                        <span x-show="element.config?.tool" class="ml-2 text-purple-dark">
                            üîß <span x-text="element.config.tool"></span>
                        </span>
                    </div>

                    <!-- Children (desglosado) -->
                    <div x-show="element.expanded && element.children.length > 0" class="mt-2 ml-4 space-y-1">
                        <template x-for="child in element.children" :key="child.id">
                            <div class="border-l-2 border-purple-pale pl-2 py-1 text-xs">
                                <div class="flex items-center gap-2">
                                    <button @click="toggleElementVisibility(child.id)"
                                            x-text="child.visible ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'"></button>
                                    <span class="flex-1" x-text="child.name"></span>
                                    <button @click="deleteElement(child.id)"
                                            class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                                </div>
                                <div class="text-gray-600 mt-1">
                                    <span x-show="!child.config">[hereda]</span>
                                    <span x-show="child.config" class="text-purple-medium">‚úèÔ∏è Config propia</span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <div x-show="elements.length === 0" class="text-center text-gray-400 py-8 text-sm">
                No hay elementos.<br>Agrega un SVG o dibuja una figura.
            </div>
        </div>
    </div>
</div>
                        <!-- Config Tab -->
                        <div x-show="currentTab === 'config'" class="space-y-6">
                            <div>
                                <h3 class="text-sm font-semibold text-purple-dark mb-3">Tipo de Operaci√≥n</h3>
                                <select x-model="operationType"
                                        @change="updateConfigVisibility"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="cnc">Corte CNC</option>
                                    <option value="laser">L√°ser</option>
                                </select>
                            </div>

                            <div>
                                <h3 class="text-sm font-semibold text-purple-dark mb-3">Herramienta</h3>
                                <select x-model="selectedTool"
                                        @change="applyToolSettings"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="">Seleccionar...</option>
                                    <template x-for="tool in tools" :key="tool.name">
                                        <option :value="tool.name" x-text="tool.name + ' (' + tool.diameter + 'mm)'"></option>
                                    </template>
                                </select>
                            </div>

                            <div>
                                <h3 class="text-sm font-semibold text-purple-dark mb-3">Material</h3>
                                <select x-model="selectedMaterial"
                                        @change="applyMaterialSettings"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="">Seleccionar...</option>
                                    <template x-for="mat in materials" :key="mat.name">
                                        <option :value="mat.name" x-text="mat.name + ' (' + mat.thickness + 'mm)'"></option>
                                    </template>
                                </select>
                            </div>

                            <div x-show="operationType === 'cnc'">
                                <h3 class="text-sm font-semibold text-purple-dark mb-3">Par√°metros CNC</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-xs text-gray-600">Profundidad total (mm)</label>
                                        <input type="number" x-model="config.depth" step="0.1"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-600">Profundidad por pasada (mm)</label>
                                        <input type="number" x-model="config.depthStep" step="0.1"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-600">Di√°metro herramienta (mm)</label>
                                        <input type="number" x-model="config.toolDiameter" step="0.001"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-600">Compensaci√≥n</label>
                                        <select x-model="config.compensation"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg mt-1">
                                            <option value="center">Centro (por el borde)</option>
                                            <option value="inside">Interior (dentro)</option>
                                            <option value="outside">Exterior (fuera)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-sm font-semibold text-purple-dark mb-3">Velocidades</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-xs text-gray-600">Feed rate (mm/min)</label>
                                        <input type="number" x-model="config.feedRate" step="50"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg mt-1">
                                    </div>
                                    <div x-show="operationType === 'cnc'">
                                        <label class="text-xs text-gray-600">Plunge rate (mm/min)</label>
                                        <input type="number" x-model="config.plungeRate" step="50"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg mt-1">
                                    </div>
                                    <div x-show="operationType === 'cnc'">
                                        <label class="text-xs text-gray-600">Spindle RPM</label>
                                        <input type="number" x-model="config.spindleRPM" step="1000"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg mt-1">
                                    </div>
                                    <div x-show="operationType === 'laser'">
                                        <label class="text-xs text-gray-600">Potencia l√°ser (%)</label>
                                        <input type="number" x-model="config.laserPower" min="0" max="100"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg mt-1">
                                    </div>
                                </div>
                            </div>

                            <div class="bg-purple-ultra-pale rounded-lg p-4">
                                <h3 class="text-sm font-semibold text-purple-dark mb-2">Estimaciones</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Tiempo:</span>
                                        <span class="font-semibold text-purple-medium" x-text="estimates.time"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Distancia:</span>
                                        <span class="font-semibold text-purple-medium" x-text="estimates.distance"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Jog Tab -->
                        <div x-show="currentTab === 'jog'" class="space-y-6">
                            <div>
                                <h3 class="text-sm font-semibold text-purple-dark mb-3">Distancia</h3>
                                <div class="flex gap-2">
                                    <template x-for="dist in [0.1, 1, 10, 100]" :key="dist">
                                        <button @click="jogDistance = dist"
                                                :class="jogDistance === dist ? 'bg-purple-medium text-white' : 'bg-gray-100'"
                                                class="flex-1 py-2 rounded-lg font-medium text-sm transition"
                                                x-text="dist"></button>
                                    </template>
                                </div>
                                <span class="text-xs text-gray-500 mt-1">mm</span>
                            </div>

                            <div>
                                <h3 class="text-sm font-semibold text-purple-dark mb-3">Velocidad</h3>
                                <input type="range" x-model="jogSpeed" min="100" max="5000" step="100" class="w-full">
                                <div class="flex justify-between text-xs text-gray-600 mt-1">
                                    <span>100</span>
                                    <span x-text="jogSpeed + ' mm/min'" class="font-semibold"></span>
                                    <span>5000</span>
                                </div>
                            </div>

                            <div>
                                <div class="grid grid-cols-3 gap-2 mb-2">
                                    <div></div>
                                    <button @click="jog('Y', jogDistance)"
                                            class="aspect-square bg-purple-ultra-pale hover:bg-purple-pale rounded-lg flex items-center justify-center text-2xl transition">
                                        ‚ñ≤
                                    </button>
                                    <div></div>
                                    <button @click="jog('X', -jogDistance)"
                                            class="aspect-square bg-purple-ultra-pale hover:bg-purple-pale rounded-lg flex items-center justify-center text-2xl transition">
                                        ‚óÑ
                                    </button>
                                    <button @click="sendCommand('$H')"
                                            class="aspect-square bg-purple-medium text-white hover:bg-purple-dark rounded-lg flex items-center justify-center text-2xl transition">
                                        ‚åÇ
                                    </button>
                                    <button @click="jog('X', jogDistance)"
                                            class="aspect-square bg-purple-ultra-pale hover:bg-purple-pale rounded-lg flex items-center justify-center text-2xl transition">
                                        ‚ñ∫
                                    </button>
                                    <div></div>
                                    <button @click="jog('Y', -jogDistance)"
                                            class="aspect-square bg-purple-ultra-pale hover:bg-purple-pale rounded-lg flex items-center justify-center text-2xl transition">
                                        ‚ñº
                                    </button>
                                </div>

                                <div class="grid grid-cols-2 gap-2 mt-4">
                                    <button @click="jog('Z', jogDistance)"
                                            class="bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-medium transition">
                                        Z ‚ñ≤
                                    </button>
                                    <button @click="jog('Z', -jogDistance)"
                                            class="bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-medium transition">
                                        Z ‚ñº
                                    </button>
                                </div>
                            </div>

                            <div class="space-y-2">
                                <button @click="sendCommand('G0 X0 Y0 Z0')"
                                        class="w-full bg-gray-200 hover:bg-gray-300 py-2 rounded-lg text-sm transition">
                                    Ir a Origen
                                </button>
                                <button @click="sendCommand('G38.2 Z-20 F100')"
                                        class="w-full bg-gray-200 hover:bg-gray-300 py-2 rounded-lg text-sm transition">
                                    Probe Z
                                </button>
                            </div>
                        </div>

                        <!-- G-code Tab -->
                        <div x-show="currentTab === 'gcode'" class="space-y-4">
                            <div class="flex items-center justify-between">
                                <h3 class="text-sm font-semibold text-purple-dark">G-code Generado</h3>
                                <span class="text-xs text-gray-600" x-text="gcodeLines + ' l√≠neas'"></span>
                            </div>
                            <textarea x-model="gcode"
                                      readonly
                                      class="w-full h-96 px-3 py-2 bg-purple-bg border border-gray-300 rounded-lg font-mono text-xs"
                                      placeholder="El G-code aparecer√° aqu√≠..."></textarea>

                            <div x-show="sending" class="space-y-2">
                                <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                    <div class="bg-green-500 h-2 transition-all duration-300"
                                         :style="'width: ' + sendProgress + '%'"></div>
                                </div>
                                <p class="text-sm text-center text-gray-600" x-text="sendProgress.toFixed(1) + '%'"></p>
                            </div>
                        </div>

                        <!-- Console Tab -->
                        <div x-show="currentTab === 'console'" class="space-y-4">
                            <div class="flex items-center justify-between">
                                <h3 class="text-sm font-semibold text-purple-dark">Consola GRBL</h3>
                                <button @click="clearConsole" class="text-xs text-gray-600 hover:text-purple-medium">
                                    Limpiar
                                </button>
                            </div>
                            <div x-ref="consoleOutput"
                                 class="h-96 bg-gray-900 rounded-lg p-3 overflow-y-auto font-mono text-xs text-green-400">
                                <template x-for="(line, index) in consoleLines" :key="index">
                                    <div x-text="line"></div>
                                </template>
                            </div>
                            <div class="flex gap-2">
                                <input type="text"
                                       x-model="consoleInput"
                                       @keyup.enter="sendConsoleCommand"
                                       :disabled="!connected"
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                       placeholder="Comando manual...">
                                <button @click="sendConsoleCommand"
                                        :disabled="!connected"
                                        class="bg-purple-medium hover:bg-purple-dark text-white px-4 py-2 rounded-lg text-sm transition disabled:bg-gray-300">
                                    Enviar
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </main>

        <!-- Modal Work Area - Agregar antes del cierre de </div> principal -->
<div x-show="showWorkAreaModal"
     @click.self="closeWorkAreaModal()"
     class="modal-backdrop"
     style="display: none;"
     x-transition>
    <div class="modal-content" @click.stop>
        <div class="bg-purple-dark text-white px-6 py-4 rounded-t-lg">
            <h2 class="text-xl font-bold">‚öôÔ∏è Configurar √Årea de Trabajo</h2>
        </div>

        <div class="p-6 space-y-6">
            <!-- Presets -->
            <div>
                <h3 class="text-sm font-semibold text-purple-dark mb-3">Tama√±os Predefinidos</h3>
                <div class="grid grid-cols-3 gap-2">
                    <button @click="setPresetWorkArea(300, 300)"
                            class="px-3 py-2 bg-purple-ultra-pale hover:bg-purple-pale rounded-lg text-sm transition">
                        300x300mm
                    </button>
                    <button @click="setPresetWorkArea(400, 400)"
                            class="px-3 py-2 bg-purple-ultra-pale hover:bg-purple-pale rounded-lg text-sm transition">
                        400x400mm
                    </button>
                    <button @click="setPresetWorkArea(600, 400)"
                            class="px-3 py-2 bg-purple-ultra-pale hover:bg-purple-pale rounded-lg text-sm transition">
                        600x400mm
                    </button>
                    <button @click="setPresetWorkArea(800, 600)"
                            class="px-3 py-2 bg-purple-ultra-pale hover:bg-purple-pale rounded-lg text-sm transition">
                        800x600mm
                    </button>
                    <button @click="setPresetWorkArea(1000, 600)"
                            class="px-3 py-2 bg-purple-ultra-pale hover:bg-purple-pale rounded-lg text-sm transition">
                        1000x600mm
                    </button>
                    <button @click="setPresetWorkArea(1200, 800)"
                            class="px-3 py-2 bg-purple-ultra-pale hover:bg-purple-pale rounded-lg text-sm transition">
                        1200x800mm
                    </button>
                </div>
            </div>

            <!-- Custom Size -->
            <div>
                <h3 class="text-sm font-semibold text-purple-dark mb-3">Tama√±o Personalizado</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-600 block mb-1">Ancho (mm)</label>
                        <input type="number"
                               x-model.number="tempWorkArea.width"
                               min="100"
                               max="2000"
                               step="10"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="text-xs text-gray-600 block mb-1">Alto (mm)</label>
                        <input type="number"
                               x-model.number="tempWorkArea.height"
                               min="100"
                               max="2000"
                               step="10"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                </div>
            </div>

            <!-- Preview -->
            <div class="bg-purple-ultra-pale rounded-lg p-4">
                <p class="text-sm text-gray-600 mb-2">Vista previa:</p>
                <p class="text-2xl font-bold text-purple-medium text-center">
                    <span x-text="tempWorkArea.width"></span> x <span x-text="tempWorkArea.height"></span> mm
                </p>
            </div>

            <!-- Actions -->
            <div class="flex gap-3">
                <button @click="closeWorkAreaModal()"
                        class="flex-1 px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium transition">
                    Cancelar
                </button>
                <button @click="applyWorkArea()"
                        class="flex-1 px-4 py-3 bg-purple-medium hover:bg-purple-dark text-white rounded-lg font-medium transition">
                    ‚úì Aplicar
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal GRBL Settings - Agregar antes del cierre de </div> principal -->
<div x-show="showGRBLModal"
     @click.self="closeGRBLModal()"
     class="modal-backdrop"
     style="display: none;"
     x-transition>
    <div class="modal-content w-full max-w-4xl" @click.stop>
        <div class="bg-purple-dark text-white px-6 py-4 rounded-t-lg flex items-center justify-between">
            <h2 class="text-xl font-bold">‚öôÔ∏è Configuraci√≥n GRBL</h2>
            <button @click="closeGRBLModal()" class="text-2xl hover:text-purple-pale">&times;</button>
        </div>

        <div class="p-6 space-y-4">
            <!-- Actions -->
            <div class="flex gap-3">
                <button @click="loadGRBLSettings()"
                        :disabled="!connected"
                        :class="connected ? 'bg-purple-medium hover:bg-purple-dark' : 'bg-gray-300'"
                        class="px-4 py-2 text-white rounded-lg transition">
                    üîÑ Leer Configuraci√≥n
                </button>
                <button @click="saveGRBLSettings()"
                        :disabled="!connected || grblSettings.length === 0"
                        class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition disabled:bg-gray-300">
                    üíæ Guardar Cambios
                </button>
                <button @click="resetGRBLSettings()"
                        :disabled="!connected"
                        class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition disabled:bg-gray-300">
                    ‚ö†Ô∏è Reset a Factory
                </button>
            </div>

            <!-- Search -->
            <input type="text"
                   x-model="grblSearchQuery"
                   placeholder="üîç Buscar configuraci√≥n..."
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg">

            <!-- Settings Table -->
            <div class="h-96 overflow-y-auto border border-gray-300 rounded-lg">
                <table class="w-full text-sm">
                    <thead class="bg-purple-ultra-pale sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left w-24">C√≥digo</th>
                            <th class="px-3 py-2 text-left">Descripci√≥n</th>
                            <th class="px-3 py-2 text-left w-32">Valor</th>
                            <th class="px-3 py-2 w-16">Ayuda</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="setting in filteredGRBLSettings()" :key="setting.code">
                            <tr class="border-b hover:bg-purple-ultra-pale">
                                <td class="px-3 py-2 font-mono font-semibold text-purple-medium" x-text="setting.code"></td>
                                <td class="px-3 py-2 text-gray-700" x-text="setting.description"></td>
                                <td class="px-3 py-2">
                                    <input type="number"
                                           x-model="setting.value"
                                           step="0.001"
                                           class="w-full px-2 py-1 border border-gray-300 rounded text-right font-mono">
                                </td>
                                <td class="px-3 py-2 text-center">
                                    <button @click="showGRBLHelp(setting)"
                                            class="text-purple-medium hover:text-purple-dark text-lg"
                                            title="Ver ayuda">
                                        ‚ùì
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>

                <div x-show="grblSettings.length === 0" class="p-8 text-center text-gray-500">
                    <p>No hay configuraciones cargadas.</p>
                    <p class="text-sm mt-2">Conecta la m√°quina y presiona "Leer Configuraci√≥n"</p>
                </div>
            </div>

            <!-- Status -->
            <div x-show="grblSettingsStatus"
                 class="p-3 rounded-lg text-sm"
                 :class="grblSettingsStatus.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'">
                <span x-text="grblSettingsStatus.message"></span>
            </div>
        </div>
    </div>
</div>

<!-- Modal Help - Para mostrar ayuda detallada -->
<div x-show="showGRBLHelpModal"
     @click.self="showGRBLHelpModal = false"
     class="modal-backdrop"
     style="display: none;"
     x-transition>
    <div class="modal-content w-full max-w-2xl" @click.stop>
        <div class="bg-purple-dark text-white px-6 py-4 rounded-t-lg flex items-center justify-between">
            <h2 class="text-xl font-bold" x-text="'Ayuda: ' + currentGRBLHelp.code"></h2>
            <button @click="showGRBLHelpModal = false" class="text-2xl hover:text-purple-pale">&times;</button>
        </div>

        <div class="p-6 space-y-4">
            <div>
                <h3 class="font-semibold text-purple-dark mb-2">Descripci√≥n:</h3>
                <p class="text-gray-700" x-text="currentGRBLHelp.description"></p>
            </div>

            <div x-show="currentGRBLHelp.help">
                <h3 class="font-semibold text-purple-dark mb-2">Detalles:</h3>
                <p class="text-gray-700 text-sm" x-text="currentGRBLHelp.help"></p>
            </div>

            <div x-show="currentGRBLHelp.unit" class="bg-purple-ultra-pale rounded-lg p-3">
                <span class="text-sm">
                    <strong>Unidad:</strong> <span x-text="currentGRBLHelp.unit"></span>
                </span>
            </div>

            <button @click="showGRBLHelpModal = false"
                    class="w-full bg-purple-medium hover:bg-purple-dark text-white px-4 py-2 rounded-lg transition">
                Cerrar
            </button>
        </div>
    </div>
</div>
    </div>

    <!-- Scripts - Cargar en orden correcto SIN modules -->
    <script src="js/canvas-manager.js"></script>
    <script src="js/gcode-generator.js"></script>
    <script src="js/serial-control.js"></script>
    <script src="js/library-manager.js"></script>
    <script src="js/app.js"></script>

    <!-- Alpine.js - √öLTIMO -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
</body>
</html>

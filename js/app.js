// ============================================
// GRBL Web Control Pro v3.0 - Main App
// ============================================
import { CanvasManager } from './canvas-manager.js';
import { GCodeGenerator } from './gcode-generator.js';
import { SerialControl } from './serial-control.js';
import { LibraryManager } from './library-manager.js';

// ============================================
// ALPINE.JS APP
// ============================================
window.grblApp = function() {
    return {
        // Managers
        canvasManager: null,
        gcodeGenerator: null,
        serialControl: null,
        libraryManager: null,

        // State
        connected: false,
        svgLoaded: false,
        gcodeGenerated: false,
        sending: false,

        // Machine
        machineState: 'Idle',
        feedOverride: 100,
        spindleOverride: 100,

        // Position
        position: { x: '0.000', y: '0.000', z: '0.000' },
        posMode: 'WPos',

        // UI
        currentTab: 'config',
        currentTool: 'select',
        tabs: [
            { id: 'config', name: 'Config', icon: 'âš™ï¸' },
            { id: 'jog', name: 'Jog', icon: 'ðŸŽ®' },
            { id: 'gcode', name: 'G-code', icon: 'ðŸ“' },
            { id: 'console', name: 'Consola', icon: 'ðŸ’»' }
        ],

        // SVG info
        svgPosition: 'X: 0, Y: 0',
        svgScale: '100%',
        svgRotation: '0Â°',
        workAreaSize: '400 x 400',

        // Config
        operationType: 'cnc',
        selectedTool: '',
        selectedMaterial: '',
        tools: [],
        materials: [],
        config: {
            depth: -3,
            depthStep: 1,
            toolDiameter: 3.175,
            compensation: 'center',
            feedRate: 800,
            plungeRate: 400,
            spindleRPM: 10000,
            laserPower: 60
        },

        // Jog
        jogDistance: 1,
        jogSpeed: 1000,

        // G-code
        gcode: '',
        gcodeLines: 0,
        sendProgress: 0,
        estimates: { time: '-', distance: '-' },

        // Console
        consoleLines: [],
        consoleInput: '',

        // Init
        async init() {
            console.log('ðŸš€ Initializing GRBL Web Control Pro v3.5...');

            // Create managers
            this.canvasManager = new CanvasManager(this);
            this.gcodeGenerator = new GCodeGenerator();
            this.serialControl = new SerialControl(this);
            this.libraryManager = new LibraryManager(this);

            // Init canvas
            const canvas = this.$refs.canvas;
            if (canvas) {
                this.canvasManager.init(canvas);
                console.log('âœ… Canvas inicializado');
            } else {
                console.error('âŒ Canvas element not found');
            }

            // Load libraries
            this.tools = await this.libraryManager.loadTools();
            this.materials = await this.libraryManager.loadMaterials();
            console.log('âœ… Libraries loaded:', this.tools.length, 'tools,', this.materials.length, 'materials');

            console.log('âœ… App initialized successfully!');
        },

        // Connection
        async toggleConnection() {
            if (this.connected) {
                await this.serialControl.disconnect();
                this.connected = false;
                this.addConsoleLine('Disconnected');
            } else {
                const result = await this.serialControl.connect();
                this.connected = result;
                if (result) {
                    this.addConsoleLine('âœ… Connected to GRBL');
                }
            }
        },

        // SVG
        loadSVG() {
            this.$refs.svgInput.click();
        },

        async handleSVGUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('ðŸ“‚ Loading SVG:', file.name);

            try {
                await this.canvasManager.loadSVG(file);
                this.svgLoaded = true;
                this.addConsoleLine('âœ… SVG cargado: ' + file.name);

                // Auto fit view after a moment
                setTimeout(() => {
                    this.canvasManager.fitView();
                }, 100);

            } catch (error) {
                console.error('Error loading SVG:', error);
                this.addConsoleLine('âŒ Error loading SVG: ' + error.message);
                alert('Error loading SVG: ' + error.message);
            }
        },

        // Tools
        selectTool(tool) {
            this.currentTool = tool;
            if (this.canvasManager && this.canvasManager.fabricCanvas) {
                switch(tool) {
                    case 'move':
                        this.canvasManager.fabricCanvas.defaultCursor = 'move';
                        break;
                    case 'rotate':
                        this.canvasManager.fabricCanvas.defaultCursor = 'grab';
                        break;
                    default:
                        this.canvasManager.fabricCanvas.defaultCursor = 'default';
                }
            }
        },

        zoomIn() {
            if (this.canvasManager) {
                this.canvasManager.zoomIn();
            }
        },

        zoomOut() {
            if (this.canvasManager) {
                this.canvasManager.zoomOut();
            }
        },

        fitView() {
            if (this.canvasManager) {
                this.canvasManager.fitView();
            }
        },

        resetOrigin() {
            if (this.canvasManager) {
                this.canvasManager.resetOrigin();
                this.svgPosition = 'X: 0, Y: 0';
                this.svgScale = '100%';
                this.svgRotation = '0Â°';
            }
        },

        // G-code
        generateGCode() {
            if (!this.svgLoaded) {
                alert('Carga un SVG primero');
                return;
            }

            const paths = this.canvasManager.getPaths();
            this.gcode = this.gcodeGenerator.generate(paths, this.config, this.operationType);
            this.gcodeLines = this.gcode.split('\n').length;
            this.gcodeGenerated = true;

            const est = this.gcodeGenerator.calculateEstimates(this.gcode, this.config);
            this.estimates.time = est.time.toFixed(0) + 's';
            this.estimates.distance = est.distance.toFixed(2) + ' mm';

            this.addConsoleLine('âœ… G-code generated: ' + this.gcodeLines + ' lines');
            this.currentTab = 'gcode';
        },

        downloadGCode() {
            if (!this.gcodeGenerated) return;

            const blob = new Blob([this.gcode], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'output.gcode';
            a.click();
            URL.revokeObjectURL(url);

            this.addConsoleLine('âœ… G-code downloaded');
        },

        sendToGRBL() {
            if (!this.connected || !this.gcodeGenerated) return;
            alert('Send to GRBL - En desarrollo');
        },

        // Commands
        sendCommand(cmd) {
            if (!this.connected) return;
            this.serialControl.sendCommand(cmd);
            this.addConsoleLine('> ' + cmd);
        },

        reset() {
            if (confirm('Â¿Reset GRBL?')) {
                this.serialControl.reset();
            }
        },

        emergencyStop() {
            if (confirm('ðŸ›‘ Â¿STOP INMEDIATO?')) {
                this.serialControl.emergencyStop();
                this.addConsoleLine('ðŸ›‘ EMERGENCY STOP');
            }
        },

        togglePosMode() {
            this.posMode = this.posMode === 'WPos' ? 'MPos' : 'WPos';
        },

        // Jog
        jog(axis, distance) {
            if (!this.connected) return;
            this.serialControl.jog(axis, distance, this.jogSpeed);
        },

        // Console
        sendConsoleCommand() {
            if (!this.consoleInput.trim()) return;
            this.sendCommand(this.consoleInput);
            this.consoleInput = '';
        },

        addConsoleLine(line) {
            const timestamp = new Date().toLocaleTimeString();
            this.consoleLines.push(`[${timestamp}] ${line}`);

            if (this.consoleLines.length > 200) {
                this.consoleLines.shift();
            }

            // Auto scroll
            this.$nextTick(() => {
                const el = this.$refs.consoleOutput;
                if (el) {
                    el.scrollTop = el.scrollHeight;
                }
            });
        },

        clearConsole() {
            this.consoleLines = [];
        },

        // Settings
        applyToolSettings() {
            const tool = this.libraryManager.getTool(this.selectedTool);
            if (tool) {
                this.config.toolDiameter = tool.diameter;
                this.config.feedRate = tool.feedRate;
                this.config.spindleRPM = tool.rpm;
                this.addConsoleLine('âœ… Tool applied: ' + tool.name);
            }
        },

        applyMaterialSettings() {
            const mat = this.libraryManager.getMaterial(this.selectedMaterial);
            if (mat) {
                this.config.feedRate = mat.feedRate;
                this.config.spindleRPM = mat.rpm;
                this.config.depthStep = mat.depthPerPass;
                this.addConsoleLine('âœ… Material applied: ' + mat.name);
            }
        },

        updateConfigVisibility() {
            // Auto handled by Alpine
        },

        updateTransformInfo(transform) {
            this.svgPosition = `X: ${transform.x.toFixed(1)}, Y: ${transform.y.toFixed(1)}`;
            this.svgScale = `${(transform.scale * 100).toFixed(0)}%`;
            this.svgRotation = `${transform.rotation.toFixed(0)}Â°`;
        },

        openModal(modalId) {
            console.log('Opening modal:', modalId);
            alert('Modal ' + modalId + ' - En desarrollo');
        }
    };
};

console.log('âœ… GRBL Web Control Pro v3.0 - Modular version loaded');
